<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MOUSE AI ğŸ­ â€” Ø¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª IPTV</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#001226">
  <style>
    :root{--bg:#07101a;--primary:#00a8ff;--muted:#9fb0c8;--card:#0b1620;--text:#eaf6ff}
    *{box-sizing:border-box;font-family:'Tajawal',sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#02030a);color:var(--text);min-height:100vh}
    header{height:86px;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:linear-gradient(90deg,#000,#001025 45%,var(--primary));box-shadow:0 8px 40px rgba(0,0,0,.6)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:radial-gradient(circle,#00213a,#004c99);display:flex;align-items:center;justify-content:center;font-size:20px}
    h1{font-size:1.05rem;margin:0;background:linear-gradient(90deg,#002b4d,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    main{display:flex;gap:18px;padding:18px;align-items:flex-start;flex-wrap:wrap}
    aside{width:420px;background:linear-gradient(180deg,var(--card),#071126);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.03);box-shadow:0 10px 40px rgba(0,0,0,.6)}
    section.content{flex:1;min-width:320px;background:linear-gradient(180deg,#06121a,#071024);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,.03);box-shadow:0 18px 60px rgba(0,0,0,.6)}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type="text"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--text);margin-bottom:10px;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    button{background:transparent;border:1px solid rgba(255,255,255,.06);padding:10px 12px;border-radius:8px;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(90deg,#0066cc,var(--primary));border:none}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:8px;text-align:right;border-bottom:1px solid rgba(255,255,255,.03)}
    .preview{background:rgba(255,255,255,.02);padding:10px;border-radius:8px;margin-top:12px;color:#cfeeff;font-size:13px;white-space:pre-wrap;max-height:260px;overflow:auto;border:1px solid rgba(255,255,255,.02)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.03);font-size:13px;color:var(--muted)}
    footer{padding:14px 20px;text-align:center;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,.02);margin-top:18px}
    @media(max-width:980px){aside{width:100%}section.content{width:100%}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">ğŸ­</div>
      <div>
        <h1>MOUSE AI ğŸ­ â€” Ø¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª IPTV</h1>
        <div class="muted">ÙˆØ§Ø¬Ù‡Ø© ØªØ«Ø¨ÙŠØªÙŠØ© (PWA) + proxy Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Vercel</div>
      </div>
    </div>
    <div class="muted">Ø­Ù‚ÙˆÙ‚ Â© MOUSE AI</div>
  </header>

  <main>
    <aside>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª</div>
        <div class="chip" id="serverCount">0 Ø³ÙŠØ±ÙØ±</div>
      </div>

      <label>Ù„ØµÙ‚ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ = Host[:Port] âŸ¶ Tab Ø£Ùˆ Ù…Ø³Ø§ÙØªØ§Ù† âŸ¶ Username âŸ¶ Password)</label>
      <textarea id="bulkInput" placeholder="Ù…Ø«Ø§Ù„: fortv.cc:8080	1A63fh	337373"></textarea>

      <div class="controls">
        <button class="primary" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        <button id="btnClear" class="small">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>

      <label>Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</label>
      <select id="templateSelect">
        <option value="xtream">Xtream: {protocol}://{host}/get.php?username={user}&password={pass}&type=m3u</option>
        <option value="m3u_url">Basic auth: {protocol}://{user}:{pass}@{host}/playlist.m3u</option>
        <option value="custom">Ù…Ø®ØµØµ</option>
      </select>
      <input id="customTemplate" placeholder="Ù‚Ø§Ù„Ø¨ Ù…Ø®ØµØµ (Ù…Ø«Ø§Ù„: https://{host}/live/{user}/{pass}/index.m3u)" style="display:none" />

      <div class="controls" style="margin-top:10px">
        <button id="btnGenerate" class="primary">Ø¥Ù†Ø´Ø§Ø¡ M3U Ù…Ø¯Ù…Ø¬Ø©</button>
        <button id="btnExportAll" class="small">ØªØ­Ù…ÙŠÙ„</button>
        <button id="btnCopy" class="small">Ù†Ø³Ø®</button>
      </div>

      <label>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù†Ø§ØªØ¬</label>
      <div id="preview" class="preview">Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ M3U Ù…Ø¯Ù…Ø¬Ø©" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‡Ù†Ø§.</div>

      <div style="margin-top:12px">
        <div style="font-weight:700;margin-bottom:8px">Ø³ÙŠØ±ÙØ±Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>
        <table id="serversTbl"><thead><tr><th>Host:Port</th><th>Username</th><th>Password</th><th>Ù…ØµØ¯Ø±</th><th>Ø­Ø°Ù</th></tr></thead><tbody></tbody></table>
      </div>
    </aside>

    <section class="content">
      <h2>ØªØ´ØºÙŠÙ„ ÙˆÙ†Ø´Ø± Ø¹Ù„Ù‰ Vercel</h2>
      <p class="muted">Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¹ Ù…Ø¬Ù„Ø¯ <code>api/proxy.js</code> Ùˆ <code>vercel.json</code> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª M3U Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø¹Ù„Ù‰ Vercel: <code>/api/proxy?url=ENCODED_URL</code></p>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:12px 0">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="h_host" type="text" placeholder="Host[:Port]" style="flex:1" />
        <input id="h_user" type="text" placeholder="Username" />
        <input id="h_pass" type="text" placeholder="Password" />
        <button id="btnAddSave" class="primary">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <div style="margin-top:12px" class="muted">
        Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ­Ù…ÙŠÙ„ M3U Ø®Ø§Ø±Ø¬ÙŠ Ù‚Ø¯ ÙŠÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ CORS â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø§Ù„Ù…Ø¶Ù…Ù‘Ù† Ø¹Ù„Ù‰ Vercel Ø£Ùˆ Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹.
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:12px 0">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: <span id="appStatus" class="muted">Ø¬Ø§Ù‡Ø²</span></div>
        <div>
          <button id="btnTestOpen" class="small">ÙØªØ­ Ø£ÙˆÙ„ Ø±Ø§Ø¨Ø·</button>
          <button id="btnClearCache" class="small">Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Ø­Ù‚ÙˆÙ‚ Â© MOUSE AI ğŸ­ â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„. Ø§Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©.
  </footer>

<script>
/* ======= Keys / storage ======= */
const STORAGE_KEY = 'mouse_ai_merge_servers_v1';
const PREVIEW_CACHE = 'mouse_ai_merge_preview_v1';

/* ======= Helpers ======= */
const qs = s => document.querySelector(s);
function loadServers(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ return [] } }
function saveServers(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function id(){ return Math.random().toString(36).slice(2,9); }

/* ======= UI elements ======= */
const bulkInput = qs('#bulkInput');
const btnImport = qs('#btnImport');
const btnClear = qs('#btnClear');
const serversTblBody = qs('#serversTbl tbody');
const serverCountChip = qs('#serverCount');
const templateSelect = qs('#templateSelect');
const customTemplate = qs('#customTemplate');
const btnGenerate = qs('#btnGenerate');
const previewEl = qs('#preview');
const btnExportAll = qs('#btnExportAll');
const btnCopy = qs('#btnCopy');
const btnAddSave = qs('#btnAddSave');
const h_host = qs('#h_host'), h_user = qs('#h_user'), h_pass = qs('#h_pass');
const btnTestOpen = qs('#btnTestOpen');
const btnClearCache = qs('#btnClearCache');

/* show tiny toast */
function showToast(msg){ const n = document.createElement('div'); n.textContent = msg; n.style.position='fixed'; n.style.left='50%'; n.style.transform='translateX(-50%)'; n.style.bottom='20px'; n.style.background='linear-gradient(90deg,#002b4d,#00a8ff)'; n.style.color='#fff'; n.style.padding='8px 12px'; n.style.borderRadius='8px'; n.style.zIndex=9999; document.body.appendChild(n); setTimeout(()=> { n.style.opacity=0; setTimeout(()=>n.remove(),400); },2000); }

/* parse bulk input lines */
function parseBulk(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  for (const raw of lines){
    let cols = raw.split(/\t+/);
    if (cols.length === 1) cols = raw.split(/\s{2,}/);
    if (cols.length === 1) cols = raw.split(/\s+/);
    if (cols.length >= 3){
      out.push({ host:cols[0].trim(), user:cols[1].trim(), pass:cols[2].trim(), id:id(), source:'imported' });
    }
  }
  return out;
}

/* server CRUD & render */
function renderServers(){
  const list = loadServers();
  serversTblBody.innerHTML = '';
  for (const s of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.host)}</td><td>${escapeHtml(s.user)}</td><td>${escapeHtml(s.pass)}</td><td>${escapeHtml(s.source||'manual')}</td><td><button data-id="${s.id}" class="del small">Ø­Ø°Ù</button></td>`;
    serversTblBody.appendChild(tr);
  }
  serverCountChip.textContent = list.length + ' Ø³ÙŠØ±ÙØ±';
  document.querySelectorAll('button.del').forEach(b => b.onclick = ()=>{ if(confirm('Ø­Ø°ÙØŸ')) { const idv=b.dataset.id; const arr=loadServers().filter(x=>x.id!==idv); saveServers(arr); renderServers(); }});
}

/* template builder */
function getTemplate(){
  const val = templateSelect.value;
  if (val === 'xtream') return '{protocol}://{host}/get.php?username={user}&password={pass}&type=m3u';
  if (val === 'm3u_url') return '{protocol}://{user}:{pass}@{host}/playlist.m3u';
  const custom = customTemplate.value.trim();
  return custom || '{protocol}://{host}/get.php?username={user}&password={pass}&type=m3u';
}
templateSelect.addEventListener('change', ()=>{ customTemplate.style.display = templateSelect.value === 'custom' ? 'block' : 'none'; });

/* build url filling placeholders */
function buildUrlFromTemplate(tpl, server){
  let host = server.host, protocol='http', port='';
  if (/^https?:\/\//i.test(host)){ protocol = host.startsWith('https') ? 'https' : 'http'; host = host.replace(/^https?:\/\//i,''); }
  if (host.includes(':')){ const parts = host.split(':'); const last = parts[parts.length-1]; if (/^\d+$/.test(last)){ port = last; parts.pop(); host = parts.join(':'); } }
  const hostWithPort = port ? host+':'+port : host;
  return tpl.replace(/{host}/g, hostWithPort).replace(/{user}/g, encodeURIComponent(server.user||'')).replace(/{pass}/g, encodeURIComponent(server.pass||'')).replace(/{port}/g, port).replace(/{protocol}/g, protocol);
}

/* create M3U from servers */
function generateM3U(){
  const servers = loadServers();
  if (!servers.length){ previewEl.textContent = '# Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±Ø§Øª'; return; }
  const tpl = getTemplate();
  const lines = ['#EXTM3U - MOUSE AI ğŸ­ Combined Servers'];
  for (const s of servers){
    const name = s.name || `${s.host} - ${s.user}`;
    const url = buildUrlFromTemplate(tpl, s);
    lines.push(`#EXTINF:-1,${name}`);
    lines.push(url);
  }
  const final = lines.join('\n');
  previewEl.textContent = final;
  localStorage.setItem(PREVIEW_CACHE, final);
  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
}

/* export / copy */
btnExportAll.addEventListener('click', ()=> {
  const content = localStorage.getItem(PREVIEW_CACHE) || previewEl.textContent || '';
  if (!content) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰');
  const blob = new Blob([content], { type:'application/x-mpegURL' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'MOUSE_AI_SERVERS.m3u8'; document.body.appendChild(a); a.click(); a.remove();
});
btnCopy.addEventListener('click', async ()=> {
  const content = localStorage.getItem(PREVIEW_CACHE) || previewEl.textContent || '';
  if (!content) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„Ù†Ø³Ø®');
  try{ await navigator.clipboard.writeText(content); showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: '+e.message); }
});

/* import / add / clear handlers */
btnImport.addEventListener('click', ()=> {
  const txt = bulkInput.value.trim(); if (!txt) return alert('Ø£Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
  const parsed = parseBulk(txt); if (!parsed.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø·Ø± ØµØ­ÙŠØ­Ø©');
  const cur = loadServers(); parsed.forEach(p => cur.push({ host:p.host, user:p.user, pass:p.pass, id:p.id, source:'imported' })); saveServers(cur);
  bulkInput.value = ''; renderServers(); showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
});
btnClear.addEventListener('click', ()=> { if (confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§ØªØŸ')){ saveServers([]); renderServers(); showToast('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); }});
btnAddSave.addEventListener('click', ()=> {
  const host = h_host.value.trim(), user = h_user.value.trim(), pass = h_pass.value.trim();
  if (!host || !user) return alert('Ø§Ø¯Ø®Ù„ Host Ùˆ Username');
  const cur = loadServers(); cur.push({ host, user, pass, id: id(), source:'manual' }); saveServers(cur); renderServers();
  h_host.value = h_user.value = h_pass.value = ''; showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
});

/* open first link */
btnTestOpen.addEventListener('click', ()=> {
  const content = localStorage.getItem(PREVIEW_CACHE) || previewEl.textContent || '';
  if (!content) return alert('Ø£Ù†Ø´Ø¦ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹');
  const m = content.match(/(https?:\/\/[^\s]+)/i); if (!m) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©'); window.open(m[1], '_blank');
});
btnClearCache.addEventListener('click', ()=> { localStorage.removeItem(PREVIEW_CACHE); previewEl.textContent = 'ØªÙ… Ø§Ù„Ù…Ø³Ø­'; showToast('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); });

/* init render */
function id(){ return Math.random().toString(36).slice(2,9); }
renderServers();

/* ======= fetchM3U with proxy fallback ======= */
/* use /api/proxy?url=ENCODED_URL when direct fetch fails (CORS/network) */
async function fetchM3U(url, useProxy=false, timeoutMs=15000){
  try {
    const finalUrl = useProxy ? `/api/proxy?url=${encodeURIComponent(url)}` : url;
    const controller = new AbortController();
    const idt = setTimeout(()=> controller.abort(), timeoutMs);
    const res = await fetch(finalUrl, { signal: controller.signal });
    clearTimeout(idt);
    if (!res.ok) return { ok:false, error:`HTTP ${res.status} ${res.statusText}` };
    const text = await res.text();
    return { ok:true, text };
  } catch (err) {
    return { ok:false, error: err.message || String(err) };
  }
}

/* example usage: load remote m3u with fallback to proxy */
async function loadM3UAndInsert(url){
  showToast('ØªØ­Ù…ÙŠÙ„: ' + url);
  let r = await fetchM3U(url, false);
  if (!r.ok) {
    console.warn('direct failed:', r.error, 'trying proxy');
    r = await fetchM3U(url, true);
    if (!r.ok) {
      alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ' + r.error + '\nØ¬Ø±Ø¨ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ ØªØ­Ù‚Ù‚ Ù…Ù† CORS Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… proxy Ù…Ø¯Ø¹ÙˆÙ….');
      return;
    }
  }
  // basic parse: store in preview cache (client-side)
  localStorage.setItem(PREVIEW_CACHE, r.text);
  previewEl.textContent = r.text;
  showToast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„');
}

/* expose function for testing in console (optional) */
window.loadM3UAndInsert = loadM3UAndInsert;
</script>
</body>
</html>
