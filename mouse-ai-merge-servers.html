<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOUSE AI ğŸ­ â€” Ø¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª IPTV</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#07101a;
    --panel:#041224;
    --muted:#9fb0c8;
    --primary:#00a8ff; /* Ø§Ø²Ø±Ù‚ Ù†Ø§Ø±ÙŠ */
    --accent:#ff6b6b;
    --card:#0b1620;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:'Tajawal',sans-serif}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#02030a);color:#eaf6ff;min-height:100vh}
  header{height:86px;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:linear-gradient(90deg,#000, #001025 45%, var(--primary));box-shadow:0 8px 40px rgba(0,0,0,.6)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:radial-gradient(circle,#00213a,#004c99);display:flex;align-items:center;justify-content:center;font-size:22px}
  h1{font-size:1.05rem;margin:0;background:linear-gradient(90deg,#002b4d,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .header-right{font-size:13px;color:var(--muted)}
  main{display:flex;gap:18px;padding:18px;align-items:flex-start}
  aside{width:420px;background:linear-gradient(180deg,var(--card),#071126);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.03);box-shadow:0 10px 40px rgba(0,0,0,.6)}
  section.content{flex:1;background:linear-gradient(180deg,#06121a,#071024);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,.03);box-shadow:0 18px 60px rgba(0,0,0,.6)}
  .muted{color:var(--muted);font-size:13px}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  input[type="text"], textarea, select{
    width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:#eaf6ff;margin-bottom:10px;font-size:14px;
  }
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:8px}
  .row .col{flex:1}
  button{background:transparent;border:1px solid rgba(255,255,255,.06);padding:10px 12px;border-radius:8px;color:#eaf6ff;cursor:pointer}
  button.primary{background:linear-gradient(90deg,#0066cc,var(--primary));border:none}
  .small{padding:6px 8px;font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{padding:8px;text-align:right;border-bottom:1px solid rgba(255,255,255,.03)}
  th{color:var(--muted);font-weight:600;font-size:12px}
  tr:hover td{background:linear-gradient(90deg, rgba(0,168,255,0.02), transparent)}
  .actions{display:flex;gap:6px;justify-content:flex-end}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.03);font-size:13px;color:var(--muted)}
  footer{padding:14px 20px;text-align:center;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,.02);margin-top:18px}
  .notice{background:linear-gradient(90deg, rgba(0,0,0,0.35), rgba(0,0,0,0.25));padding:10px;border-radius:8px;margin-top:10px;border:1px solid rgba(255,255,255,.02);color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .template{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .preview{background:rgba(255,255,255,.02);padding:10px;border-radius:8px;margin-top:12px;color:#cfeeff;font-size:13px;white-space:pre-wrap;max-height:280px;overflow:auto;border:1px solid rgba(255,255,255,.02)}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
  @media(max-width:980px){ aside{width:100%} main{flex-direction:column} }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">ğŸ­</div>
      <div>
        <h1>MOUSE AI ğŸ­ â€” Ø¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª IPTV</h1>
        <div class="muted">ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³ØªÙ‚Ø±Ø©ØŒ Ø³Ø±ÙŠØ¹Ø©ØŒ ÙˆÙ…ØµÙ…Ù…Ø© Ù„Ø¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª Host:Port Ù…Ø¹ Username/Password</div>
      </div>
    </div>
    <div class="header-right">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Â© MOUSE AI â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</div>
  </header>

  <main>
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <aside>
      <div class="flex-between">
        <div style="font-weight:700">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª</div>
        <div class="chip" id="serverCount">0 Ø³ÙŠØ±ÙØ±</div>
      </div>

      <div class="notice">ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± (ÙƒÙ„ Ø³Ø·Ø±: Host[:Port] TAB Username TAB Password Ø£Ùˆ Ù…ÙØµÙˆÙ„ Ø¨Ù…Ø³Ø§ÙØ§Øª). Ø¨Ø¹Ø¯Ù‡Ø§ Ø§Ø¶ØºØ· "Ø§Ø³ØªÙŠØ±Ø§Ø¯".</div>

      <label>Ù„ØµÙ‚ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª (Ù†Øµ Ø®Ø§Ù…)</label>
      <textarea id="bulkInput" placeholder="Ù…Ø«Ø§Ù„ Ø³Ø·Ø±: fortv.cc:8080  1A63fh  337373"></textarea>

      <div class="controls">
        <button class="primary" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª</button>
        <button id="btnClear" class="small">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <button id="btnAddOne" class="small">Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
      </div>

      <label>Ù‚Ø§Ù„Ø¨ Ø±Ø§Ø¨Ø· M3U Ù„Ù„Ù€ Export</label>
      <div class="template">
        <select id="templateSelect">
          <option value="xtream">Xtream-style get.php (Ø´Ø§Ø¦Ø¹)</option>
          <option value="m3u_url">Ø±Ø§Ø¨Ø· m3u Ù…Ø¨Ø§Ø´Ø± (username/password Ø¯Ø§Ø®Ù„ URL)</option>
          <option value="custom">Ù…Ø®ØµØµ (Ø§Ø³ØªØ®Ø¯Ù… {host} {user} {pass} {port})</option>
        </select>
        <input type="text" id="customTemplate" placeholder="Ù‚Ø§Ù„Ø¨ Ù…Ø®ØµØµ" style="flex:1;display:none" />
      </div>

      <div class="controls">
        <button id="btnGenerate" class="primary">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© M3U Ù…Ø¯Ù…Ø¬Ø©</button>
        <button id="btnExportAll" class="small">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù</button>
        <button id="btnCopy" class="small">Ù†Ø³Ø® Ù„Ù„Ù…Ø®Ø²Ù†</button>
      </div>

      <label>Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±)</label>
      <div id="preview" class="preview">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© M3U Ù…Ø¯Ù…Ø¬Ø©".</div>

      <div style="margin-top:12px">
        <div style="font-weight:700;margin-bottom:8px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
        <table id="serversTbl">
          <thead><tr><th>Host:Port</th><th>Username</th><th>Password</th><th>Ù…ØµØ¯Ø±</th><th style="width:120px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </aside>

    <!-- Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <section class="content">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div style="font-weight:800;font-size:18px">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª IPTV</div>
        <div class="muted">MOUSE AI ğŸ­ â€” Ø¯Ù…Ø¬ Ø°ÙƒÙŠ ÙˆØ³Ù‡Ù„</div>
      </div>

      <div style="margin-top:12px" class="muted">
        â€¢ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ†Ø´Ø¦ Ù…Ù„Ù M3U ÙŠØ­ØªÙˆÙŠ Ø±ÙˆØ§Ø¨Ø· Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ø³ÙŠØ±ÙØ± ÙˆÙÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨. Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ù…Ø´ØºÙ‘Ù„ ÙŠØ¯Ø¹Ù… M3U Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø´ØºÙ‘Ù„ Ø¨Ø·Ù„Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©.<br>
        â€¢ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ø§Ù†: ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ URLØ› Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,.03)">

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <label>Ø§Ø¶Ù Ø³ÙŠØ±ÙØ± Ø¬Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹</label>
          <div class="row">
            <input id="h_host" type="text" placeholder="Host[:Port]" />
          </div>
          <div class="row">
            <input id="h_user" type="text" placeholder="Username" />
            <input id="h_pass" type="text" placeholder="Password" />
          </div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="btnAddSave" class="primary">Ø¥Ø¶Ø§ÙØ©</button>
            <button id="btnGenerateSingle" class="small">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù„Ù„Ø³ÙŠØ±ÙØ±</button>
          </div>
        </div>

        <div style="flex:1;min-width:220px">
          <label>Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</label>
          <div style="display:flex;gap:8px">
            <label style="flex:1">
              <div class="muted" style="margin-bottom:6px">Ø¥Ø³Ù… Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ±</div>
              <input id="exportName" type="text" placeholder="mouse_ai_playlist.m3u8" value="MOUSE_AI_SERVERS.m3u8" />
            </label>
          </div>
          <div style="margin-top:8px" class="muted">Ù‚ÙˆØ§Ù„Ø¨ Ø´Ø§Ø¦Ø¹Ø© (Xtream: get.php?username={user}&password={pass}&type=m3u)</div>
        </div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,.03)">

      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button id="btnTestOpen" class="small">ÙØªØ­ Ø£ÙˆÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯</button>
        <button id="btnClearCache" class="small">Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ / Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­</button>
        <div class="muted" style="margin-left:auto">Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Â© MOUSE AI ğŸ­</div>
      </div>

    </section>
  </main>

  <footer>
    Ø§Ø³Ù… & Ø­Ù‚ÙˆÙ‚: MOUSE AI ğŸ­ â€” ØµÙØ­Ø© Ø¯Ù…Ø¬ Ø³ÙŠØ±ÙØ±Ø§Øª IPTV â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©. Ø§Ù„ØµÙØ­Ø© ØªØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ (client-side) Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù….
  </footer>

<script>
/* ======= Storage keys ======= */
const STORAGE_KEY = 'mouse_ai_merge_servers_v1';
const PREVIEW_CACHE = 'mouse_ai_merge_preview_v1';

/* ======= Helper functions ======= */
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function saveServers(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
function loadServers(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return [] } }
function sanitize(s){ return (s||'').toString().trim(); }
function download(filename, text){ const a = document.createElement('a'); const blob = new Blob([text],{type:'application/x-mpegURL'}); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(a.href), 2000); }

/* ======= UI elements ======= */
const bulkInput = qs('#bulkInput');
const btnImport = qs('#btnImport');
const btnClear = qs('#btnClear');
const btnAddOne = qs('#btnAddOne');
const serversTblBody = qs('#serversTbl tbody');
const serverCountChip = qs('#serverCount');
const templateSelect = qs('#templateSelect');
const customTemplate = qs('#customTemplate');
const btnGenerate = qs('#btnGenerate');
const previewEl = qs('#preview');
const btnExportAll = qs('#btnExportAll');
const btnCopy = qs('#btnCopy');
const exportNameInput = qs('#exportName');
const btnAddSave = qs('#btnAddSave');
const h_host = qs('#h_host'), h_user = qs('#h_user'), h_pass = qs('#h_pass');
const btnGenerateSingle = qs('#btnGenerateSingle');
const btnTestOpen = qs('#btnTestOpen');
const btnClearCache = qs('#btnClearCache');

/* ======= Templates ======= */
function getTemplateValue(){
  const t = templateSelect.value;
  if (t === 'xtream') return '{protocol}://{host}/get.php?username={user}&password={pass}&type=m3u';
  if (t === 'm3u_url') return '{protocol}://{user}:{pass}@{host}/playlist.m3u';
  if (t === 'custom') return sanitize(customTemplate.value) || '{protocol}://{host}/get.php?username={user}&password={pass}&type=m3u';
  return '{protocol}://{host}/get.php?username={user}&password={pass}&type=m3u';
}

/* ======= Parse bulk input (many formats) ======= */
function parseBulk(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  for (const raw of lines){
    // possible separators: tab, multiple spaces, comma
    let cols = raw.split(/\t+/);
    if (cols.length === 1) cols = raw.split(/\s{2,}/); // 2+ spaces
    if (cols.length === 1) cols = raw.split(/\s+/); // fallback single spaces
    // if only 1 column (maybe host:port|user|pass separated by |)
    if (cols.length === 1){
      const alt = raw.split(/[|,;]/).map(s=>s.trim()).filter(Boolean);
      if (alt.length >= 3) cols = alt;
    }
    if (cols.length >= 3){
      const host = sanitize(cols[0]);
      const user = sanitize(cols[1]);
      const pass = sanitize(cols[2]);
      out.push({ host, user, pass, id: Math.random().toString(36).slice(2,9), source: 'imported' });
    } else {
      // ignore invalid lines
      console.warn('Ø®Ø· Ø³Ø·Ø± ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ… ÙˆØªØ¬Ø§Ù‡Ù„:', raw);
    }
  }
  return out;
}

/* ======= Render servers table ======= */
function renderServers(){
  const list = loadServers();
  serversTblBody.innerHTML = '';
  for (const s of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(s.host)}</td>
      <td>${escapeHtml(s.user)}</td>
      <td>${escapeHtml(s.pass)}</td>
      <td>${escapeHtml(s.source || 'manual')}</td>
      <td class="actions">
        <button data-id="${s.id}" class="small edit">ØªØ¹Ø¯ÙŠÙ„</button>
        <button data-id="${s.id}" class="small del">Ø­Ø°Ù</button>
      </td>
    `;
    serversTblBody.appendChild(tr);
  }
  serverCountChip.textContent = list.length + ' Ø³ÙŠØ±ÙØ±';
  // attach events
  qsa('button.edit').forEach(b => b.onclick = ()=> editServer(b.dataset.id));
  qsa('button.del').forEach(b => b.onclick = ()=> { if(confirm('Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) deleteServer(b.dataset.id); });
  updateCategoryPreview();
}

/* ======= CRUD servers ======= */
function addServer(obj){
  const list = loadServers();
  list.push(obj);
  saveServers(list);
  renderServers();
}
function deleteServer(id){
  let list = loadServers();
  list = list.filter(s => s.id !== id);
  saveServers(list);
  renderServers();
}
function editServer(id){
  const list = loadServers();
  const s = list.find(x=>x.id===id);
  if (!s) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
  // prefill side form for quick edit
  h_host.value = s.host; h_user.value = s.user; h_pass.value = s.pass;
  // remove old, user will click "Ø¥Ø¶Ø§ÙØ©" to save (overwrite)
  deleteServer(id);
}

/* ======= Generate M3U content ======= */
function buildUrlFromTemplate(tpl, server){
  // fill placeholders: {host} {user} {pass} {port} {protocol}
  let host = server.host;
  let protocol = 'http';
  let port = '';
  // if host includes protocol prefix or port
  // accept forms: host:port or http://host:port
  const hasProto = host.match(/^https?:\/\//i);
  if (hasProto){
    const tmp = host.replace(/^https?:\/\//i, '');
    protocol = host.startsWith('https') ? 'https' : 'http';
    host = tmp;
  }
  // split host:port
  if (host.includes(':')){
    const parts = host.split(':');
    // keep ipv6 safe? in simple approach assume last part port if numeric
    const last = parts[parts.length-1];
    if (/^\d+$/.test(last)){ port = last; parts.pop(); host = parts.join(':'); }
  }
  // ensure {host} uses host:port when port present if template uses {host}
  const hostWithPort = port ? host + ':' + port : host;
  let out = tpl.replace(/{host}/g, hostWithPort)
               .replace(/{user}/g, encodeURIComponent(server.user || ''))
               .replace(/{pass}/g, encodeURIComponent(server.pass || ''))
               .replace(/{port}/g, port || '')
               .replace(/{protocol}/g, protocol);
  return out;
}

function generateM3U(){
  const servers = loadServers();
  if (servers.length === 0) {
    previewEl.textContent = '# Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±Ø§Øª - Ø£Ø¶Ù Ø£Ùˆ Ø§Ø³ØªÙˆØ±Ø¯ Ø£ÙˆÙ„Ø§Ù‹';
    return;
  }
  const tpl = getTemplateValue();
  let lines = ['#EXTM3U - MOUSE AI ğŸ­ Combined Servers'];
  for (const s of servers){
    // create friendly name
    const name = s.name || `${s.host} - ${s.user}`;
    const url = buildUrlFromTemplate(tpl, s);
    // create an EXTINF entry: you can improve group-title or tvg-logo later
    lines.push(`#EXTINF:-1 group-title="${escapeAttr(s.source||'server')}",${name}`);
    lines.push(url);
  }
  const final = lines.join('\n');
  previewEl.textContent = final;
  localStorage.setItem(PREVIEW_CACHE, final);
  return final;
}

/* ======= Utility escape ======= */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escapeAttr(s){ return (s||'').toString().replace(/"/g,'&quot;'); }

/* ======= Parse example servers provided by user (multi-line) ======= */
btnImport.onclick = () => {
  const text = bulkInput.value.trim();
  if (!text) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£ÙˆÙ„Ø§Ù‹');
  const parsed = parseBulk(text);
  if (parsed.length === 0){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø·Ø± ØµØ­ÙŠØ­Ø©'); return; }
  const list = loadServers();
  parsed.forEach(p => list.push({ host:p.host, user:p.user, pass:p.pass, id: p.id, source:'imported' }));
  saveServers(list);
  bulkInput.value = '';
  renderServers();
  showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ' + parsed.length + ' Ø³ÙŠØ±ÙØ±');
};

/* Clear all */
btnClear.onclick = () => {
  if (!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ')) return;
  saveServers([]);
  renderServers();
  showToast('ØªÙ… Ø§Ù„Ù…Ø³Ø­');
};

/* Add manual */
btnAddOne.onclick = () => {
  // open manual area focus
  h_host.focus();
};
btnAddSave.onclick = () => {
  const host = sanitize(h_host.value);
  const user = sanitize(h_user.value);
  const pass = sanitize(h_pass.value);
  if (!host || !user) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Host Ùˆ Username Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
  const id = Math.random().toString(36).slice(2,9);
  addServer({ host, user, pass, id, source:'manual' });
  // clear inputs
  h_host.value = h_user.value = h_pass.value = '';
  showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
};

/* Generate + preview */
btnGenerate.onclick = () => {
  const m3u = generateM3U();
  if (m3u) showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¬Ø§Ù‡Ø²Ø©)');
  updateCategoryPreview();
};

/* Export file */
btnExportAll.onclick = () => {
  const content = localStorage.getItem(PREVIEW_CACHE) || generateM3U() || '';
  if (!content){ return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØµØ¯ÙŠØ±. Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© M3U Ù…Ø¯Ù…Ø¬Ø©" Ø£ÙˆÙ„Ø§Ù‹.'); }
  const name = sanitize(exportNameInput.value) || 'MOUSE_AI_SERVERS.m3u8';
  download(name, content);
  showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ' + name);
};

/* Copy to clipboard */
btnCopy.onclick = async () => {
  const txt = localStorage.getItem(PREVIEW_CACHE) || previewEl.textContent || '';
  if (!txt) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„Ù†Ø³Ø®');
  try {
    await navigator.clipboard.writeText(txt);
    showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø­Ø§ÙØ¸Ø©');
  } catch(e){ alert('Ø§Ù„Ù†Ø³Ø® ÙØ´Ù„: ' + e.message); }
};

/* Generate single server URL */
btnGenerateSingle.onclick = () => {
  const host = sanitize(h_host.value);
  const user = sanitize(h_user.value);
  const pass = sanitize(h_pass.value);
  if (!host || !user) return alert('Ø§Ø¯Ø®Ù„ Host Ùˆ Username');
  const tpl = getTemplateValue();
  const url = buildUrlFromTemplate(tpl, {host,user,pass});
  previewEl.textContent = '# Ø±Ø§Ø¨Ø· ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡:\n' + url;
  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ±');
};

/* Test open first link in new tab */
btnTestOpen.onclick = () => {
  const preview = localStorage.getItem(PREVIEW_CACHE) || previewEl.textContent || '';
  if (!preview) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±. Ø£Ù†Ø´Ø¦ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.');
  // find first http(s) link
  const m = preview.match(/(https?:\/\/[^\s]+)/i);
  if (!m) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
  window.open(m[1], '_blank');
};

/* Clear cache/local preview */
btnClearCache.onclick = () => {
  if (!confirm('Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ (Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­Ù„ÙŠØ©) Ùˆ localStorageØŸ')) return;
  localStorage.removeItem(PREVIEW_CACHE);
  // optionally remove servers
  // localStorage.removeItem(STORAGE_KEY);
  previewEl.textContent = 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´';
  showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´');
};

/* show toast */
function showToast(msg){
  const elToast = document.createElement('div');
  elToast.textContent = msg;
  elToast.style.position='fixed'; elToast.style.left='50%'; elToast.style.transform='translateX(-50%)';
  elToast.style.bottom='26px'; elToast.style.background='linear-gradient(90deg,#002b4d,#00a8ff)';
  elToast.style.padding='10px 14px'; elToast.style.borderRadius='8px'; elToast.style.color='#fff'; elToast.style.zIndex=9999;
  document.body.appendChild(elToast);
  setTimeout(()=> elToast.style.opacity='0.01',2000);
  setTimeout(()=> elToast.remove(),2300);
}

/* render and initial */
renderServers();

/* utility: update preview categories list (from servers) */
function updateCategoryPreview(){
  // build category list from servers' source
  const list = loadServers();
  const cats = Array.from(new Set(list.map(s => s.source || 'server'))).slice(0,12);
  const info = 'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª: ' + (cats.length? cats.join(' â€¢ ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
  // append to preview top if empty
  if (!previewEl.textContent || previewEl.textContent.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±Ø§Øª')) {
    previewEl.textContent = info + '\n\n# Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© M3U Ù…Ø¯Ù…Ø¬Ø©" Ù„Ø¨Ø¯Ø¡';
  } else {
    previewEl.textContent = previewEl.textContent.replace(/^.*\n\n#/, info + '\n\n#'); // try to maintain
  }
}

/* Allow switching to custom template */
templateSelect.addEventListener('change', ()=>{
  if (templateSelect.value === 'custom') customTemplate.style.display = 'block';
  else customTemplate.style.display = 'none';
});

/* Auto-generate from initial user-provided list (optional) */
/* Pre-fill the bulk input with the exact list the user gave (for convenience) */
const initialData = `fortv.cc:8080\t1A63fh\t337373
tvhomesmart.xyz:8080\t32930499\t5req2f3q3
lzr.dyndns-ip.org\t9976935414\t7026008220
mytvstream.net:8080\tTWEk66\t036939
fortv.cc:8080\trQFr7P7\tQPqD5R4
lobitv65.xyz:8080\tsvd2884\tsvd.475
fruhd.cc:80\t4428202673895240\t4428202673895240
lihfd.trfhbee.xyz:25461\tc8bc9ffb28714bc2\t2f7390356eb5dc6c
lobitv65.xyz:8080\ttkn9985\tvRkBPApGQFGB
fortv.cc:8080\tY9PGbP\t167832
sasy.selfip.co:80\talecogmanc\tcognatoanto21
g.guardianplay.cc:80\tantoniosalvato\tc8sDseP16
rionetrieste1926.clickgal1.com\tGabrielealtieri8\tg3Csjhz
germanyservers1.net:8080\tcangokhan\t08eyn56cd
103.161.34.27:8080\tRobertlauc\t8vvWCeBBvAjg
eeee.blue:8080\tRN3v5fWQUN\tDXo6pG4eq5
eeee.blue:8080\tdkxMphTaaX\thH4RS6N5Mq
nuhygo.shop:8080\t2643496sec\t2643496sec
francor72.code.co.ro:8080\tcoppolatoiano\tK5e2vYatjH
aax.vkfr.co.ro:8080\tMauroma\tRomauri
nuhygo.shop:8080\tZzLCGz7kfa\tfAs6vK3AvA
skyplayau.in:8080\trandeer25h\tskyplay481h
w212sf.xyz:2086\t70:2a:d5:d8:29:74\tQzEbF5drkhfP
live.iptv.wtf\takvkwovr\t628Lhq4Ijp
hh.hdmediashop.com:2086\talizirek\tSLcyYX44Hi
nuhygo.shop:8080\tadem43\tbursa1963`;
if (!localStorage.getItem(STORAGE_KEY)) {
  bulkInput.value = initialData;
}
/* end of script */
</script>
</body>
</html>